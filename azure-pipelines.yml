resources:
 repositories:
   - repository: dummy_repo
     type: github
     endpoint: github.com_vinitamishra15
     name: vinitamishra15/dummy_repo
   - repository: Demo_test
     type: github
     endpoint: github.com_vinitamishra15
     name: vinitamishra15/Demo_test
     ref: refs/heads/master

trigger:
- main

pool: Default

variables:
  serviceNowUrl: https://dev192158.service-now.com/
  serviceNowUsername: '$(serviceNowUser)'
  serviceNowPassword: '$(serviceNowPassword)'

stages:
- stage: build
  jobs:
  - job: Build
    steps:
    - script: java -version

    # Step 1: Checkout the code from GitHub
    - checkout: self
    - checkout: dummy_repo
    - checkout: Demo_test

    # Step 2: Run SonarQube scan
    - task: SonarQubePrepare@6
      inputs:
         SonarQube: 'Sonar_conn'
         scannerMode: CLI
         configMode: file
#         configFile: 'sonar-project.properties'
         cliProjectKey: DemoScan
         cliProjectName: DemoScan


    - script: |
        sonar-scanner -Dsonar.projectKey=DemoScan -Dsonar.sources=. -Dsonar.host.url=http://localhost:9000/ -Dsonar.login=sqa_308859b46080fb65c3121ee7b6db0b465a4ea3ad
#      workingDirectory: dummy_repo
      displayName: 'Run SonarQube Analysis'

#    - task: SonarQubeAnalyze@6

#    - task: SonarQubePublish@6
#      inputs:
#        pollingTimeoutSec: 300

    # Step 3: Run Selenium test cases
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'

    - script: |
        python -m pip install --upgrade pip
        pip install selenium
        pip install webdriver-manager
        pip install pytest
      displayName: 'Install dependencies for selenium'

    - script: |
        pytest Demo_test/Testcase/test_E2EDemoApp.py --maxfail=1 --disable-warnings -q
      displayName: 'Run selenium test cases'

    # Step 2: Download the update set XML file
#    - script: |
#        echo "Downloading update set..."
#        curl -L -o update-set.xml https://raw.githubusercontent.com/vinitamishra15/Demo_repo/sn_instances/dev212832/04b8a32747401210acd2a22f316d43ef/sys_app_04b8a32747401210acd2a22f316d43ef.xml
#      displayName: 'Download Update Set'

#    # Step 3: Upload the update set to ServiceNow
#    - script: |
#        echo "Uploading update set to ServiceNow..."
#        curl -u $(serviceNowUsername):$(serviceNowPassword) -X POST "$(serviceNowUrl)/api/now/import/update_set" -H "Accept:application/json" -H "Content-Type:application/xml" --data-binary "@update-set.xml"
#      displayName: 'Upload Update Set to ServiceNow'